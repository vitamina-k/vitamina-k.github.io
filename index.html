<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>VITAMINA K ‚Äî Encuesta</title>
  <meta name="description" content="Votaci√≥n en vivo sobre intenci√≥n de voto.">
  <meta property="og:title" content="Vitamina K ‚Äî Encuesta de voto">
  <meta property="og:description" content="Participa y mira c√≥mo cambia el ranking en tiempo real.">
  <meta property="og:type" content="website">
  <style>
    *{box-sizing:border-box}
    :root{
      --bg1:#1a1f2b; --bg2:#101522; --glass:rgba(255,255,255,.10);
      --glass-2:rgba(255,255,255,.16); --stroke:rgba(255,255,255,.18);
      --fg:#fff; --muted:rgba(255,255,255,.85);
      --accent:#4ecdc4; --accent-2:#7dd3fc;
      --bar:#4ecdc4; --bar-bg:rgba(255,255,255,.15);
      --btn:#ffffff29; --btn-stroke:#ffffff44;
    }
    html,body{
      margin:0; min-height:100%;
      background:linear-gradient(135deg,var(--bg1),var(--bg2));
      color:var(--fg);
      font:16px/1.5 -apple-system,BlinkMacSystemFont,"Segoe UI",system-ui,Roboto,Inter,Arial;
    }
    .wrap{
      min-height:100vh; display:flex; align-items:center; justify-content:center; padding:24px;
    }
    .card{
      width:min(860px,96vw);
      background:var(--glass); backdrop-filter:blur(18px) saturate(1.2);
      border:1px solid var(--stroke); border-radius:20px; padding:28px;
      box-shadow:0 20px 60px rgba(0,0,0,.35);
    }
    .brand{font-weight:900; letter-spacing:.4px; text-transform:uppercase; opacity:.95; text-align:center}
    .title{font-size:clamp(22px,3.8vw,30px); text-align:center; margin:8px 0 6px}
    .sub{color:var(--muted); text-align:center; margin:0 0 20px}
    .poll{ margin-top:6px; display:flex; flex-direction:column; gap:10px; }
    .row{
      display:grid; grid-template-columns: 1.1fr 3.2fr 70px; gap:12px;
      align-items:center; padding:10px 12px; border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06); cursor:pointer;
      transition:transform .08s ease, background .2s ease, border-color .2s ease;
    }
    .row:hover{ transform:translateY(-1px); background:rgba(255,255,255,.10); border-color:rgba(255,255,255,.22); }
    .row.voted{ outline:2px solid var(--accent); background:rgba(78,205,196,.12) }
    .name{ font-weight:800; letter-spacing:.2px }
    .barline{ position:relative; width:100%; height:12px; background:var(--bar-bg); border-radius:999px; overflow:hidden }
    .fill{ position:absolute; left:0; top:0; height:100%; width:0%;
           background:linear-gradient(90deg,var(--bar),var(--accent-2));
           transition: width .45s cubic-bezier(.2,.8,.2,1); }
    .pct{ text-align:right; font-variant-numeric:tabular-nums; font-weight:800 }
    .legend{ display:flex; justify-content:space-between; align-items:center; margin-top:8px; color:var(--muted); font-size:13px }
    .legend .note{ opacity:.9 }
    .legend .you{ font-weight:700; color:var(--accent) }
    .actions{ margin-top:20px; display:flex; justify-content:center; gap:12px; flex-wrap:wrap }
    .btn{ padding:10px 14px; border-radius:12px; border:1px solid var(--btn-stroke);
          background:var(--btn); color:#fff; text-decoration:none; font-weight:700;
          transition:transform .12s ease, background .2s ease, border-color .2s ease; }
    .btn:hover{ transform:translateY(-2px); background:#ffffff33; border-color:#ffffff77 }
    .btn.primary{ background:var(--accent); color:#0b0f1a; border-color:transparent }
    .btn.primary:hover{ filter:brightness(.95) }
    /* admin total oculto; sin ‚Äútip‚Äù visible */
    #adminTotal{ display:none; margin-top:8px; text-align:right; font-size:12px; color:#cfe9ff }
    /* aviso tostada */
    .toast{position:fixed;left:50%;bottom:24px;transform:translateX(-50%);background:#111827cc;color:#fff;padding:10px 14px;border:1px solid #ffffff33;border-radius:10px;backdrop-filter:blur(10px);display:none}
  </style>
</head>
<body>
  <div class="wrap">
    <article class="card">
      <div class="brand">VITAMINAK.OF</div>
      <h1 class="title">Encuesta r√°pida ¬∑ ¬øA qui√©n votar√≠as hoy?</h1>
      <p class="sub">Vota una sola vez. La lista se ordena sola por apoyo. Mira c√≥mo suben las barras en tiempo real.</p>

      <!-- ENCUESTA -->
      <section class="poll" id="poll"></section>

      <!-- Leyenda inferior -->
      <div class="legend">
        <span class="note">Porcentaje sobre el total de votos de esta encuesta.</span>
        <span class="you" id="youBadge" style="display:none">Tu voto registrado ‚úì</span>
      </div>

      <!-- Total oculto para ti (Shift+T lo muestra/oculta) -->
      <div id="adminTotal">Total de votos: <span id="totalCount">0</span></div>

      <!-- Botones sociales + CTA -->
      <div class="actions">
        <a class="btn" href="https://www.instagram.com/vitaminak.of" target="_blank" rel="noopener">üì∏ Instagram</a>
        <a class="btn" href="https://x.com/vitaminakof" target="_blank" rel="noopener">ùïè Seguir</a>
        <a class="btn primary" href="https://www.instagram.com/vitaminak.of" target="_blank" rel="noopener">üî• S√≠gueme para ver los resultados</a>
      </div>
    </article>
  </div>

  <div class="toast" id="toast"></div>

  <script>
  (function(){
    // ======= TU ENDPOINT (Apps Script) =======
    const ENDPOINT = 'https://script.google.com/macros/s/AKfycbxfxtW-bLzKb2uPp9IImq4Ng2LhyzE8MyfQdaBSQAUr5SZmK78bf6jgD0lbwx70FKkv/exec';

    // ======= CONFIG =======
    const KEY_LOCAL = 'vk_poll_partidos_v3'; // cambiar = reset local
    const OPCIONES = [
      'PSOE',
      'Sumar',
      'PP',
      'Vox',
      'Se Acab√≥ la Fiesta',
      'Abstenci√≥n',
      'Voto nulo',
      'Otros'
    ];

    // ======= ESTADO LOCAL =======
    function loadState(){
      try{
        const raw = localStorage.getItem(KEY_LOCAL);
        if(!raw) return { voted:false, choice:'' };
        const obj = JSON.parse(raw);
        if(!obj || typeof obj!=='object') throw 0;
        if(typeof obj.voted!=='boolean') obj.voted=false;
        if(typeof obj.choice!=='string') obj.choice='';
        return obj;
      }catch(_){ return { voted:false, choice:'' }; }
    }
    function saveState(s){
      try{ localStorage.setItem(KEY_LOCAL, JSON.stringify(s)); }catch(_){}
    }
    let local = loadState();

    // ======= UI =======
    const pollEl = document.getElementById('poll');
    const totalEl = document.getElementById('totalCount');
    const youBadge = document.getElementById('youBadge');
    const toast = document.getElementById('toast');

    function showToast(msg){
      toast.textContent = msg;
      toast.style.display = 'block';
      clearTimeout(showToast._t);
      showToast._t = setTimeout(()=> toast.style.display='none', 2200);
    }

    // ======= API =======
    async function apiResults(){
      const res = await fetch(ENDPOINT + '?action=results', { method:'GET' });
      if(!res.ok) throw new Error('HTTP '+res.status);
      return res.json(); // {ok:true, votes:{nombre:count,...}, total:n}
    }

    async function apiVote(option){
      const body = new URLSearchParams({ action:'vote', option });
      const res = await fetch(ENDPOINT, {
        method:'POST',
        headers:{ 'Content-Type':'application/x-www-form-urlencoded' },
        body
      });
      if(!res.ok) throw new Error('HTTP '+res.status);
      return res.json(); // {ok:true, votes:{...}, total:n}
    }

    // ======= RENDER =======
    function ordenarPorPorcentaje(votes){
      const total = Object.values(votes).reduce((a,b)=>a+(+b||0),0) || 1;
      return [...OPCIONES].sort((a,b)=>{
        const pa = (votes[a]||0)/total;
        const pb = (votes[b]||0)/total;
        if(pb!==pa) return pb - pa; // desc
        return a.localeCompare(b);
      });
    }

    function render(votes){
      pollEl.innerHTML = '';
      const total = Object.values(votes).reduce((a,b)=>a+(+b||0),0);
      totalEl.textContent = total;

      ordenarPorPorcentaje(votes).forEach(name=>{
        const v = +votes[name] || 0;
        const pct = total ? (v*100/total) : 0;

        const row = document.createElement('div');
        row.className = 'row' + (local.voted && local.choice===name ? ' voted' : '');

        const nameEl = document.createElement('div');
        nameEl.className = 'name';
        nameEl.textContent = name;

        const barline = document.createElement('div');
        barline.className = 'barline';
        const fill = document.createElement('div');
        fill.className = 'fill';
        requestAnimationFrame(()=>{ fill.style.width = pct.toFixed(1) + '%'; });
        barline.appendChild(fill);

        const pctEl = document.createElement('div');
        pctEl.className = 'pct';
        pctEl.textContent = pct.toFixed(1) + '%';

        row.appendChild(nameEl);
        row.appendChild(barline);
        row.appendChild(pctEl);

        row.addEventListener('click', async ()=>{
          if(local.voted) return;
          try{
            const data = await apiVote(name);
            if(!data.ok) throw new Error(data.error || 'Error');
            local.voted = true;
            local.choice = name;
            saveState(local);
            youBadge.style.display = 'inline';
            render(data.votes);
            showToast('¬°Voto registrado!');
          }catch(e){
            console.error(e);
            showToast('No se pudo registrar tu voto. Int√©ntalo de nuevo.');
          }
        }, { passive:true });

        pollEl.appendChild(row);
      });

      youBadge.style.display = local.voted ? 'inline' : 'none';
    }

    // ======= CARGA INICIAL =======
    (async function init(){
      try{
        const data = await apiResults();
        if(!data.ok) throw new Error(data.error || 'Error');
        render(data.votes || {});
      }catch(e){
        console.error(e);
        // fallback: arranque en cero
        const empty = {};
        OPCIONES.forEach(o=> empty[o]=0);
        render(empty);
        showToast('No se pudo cargar el recuento inicial.');
      }
    })();

    // ======= Admin: mostrar/ocultar total con Shift+T (sin texto visible) =======
    const adminTotal = document.getElementById('adminTotal');
    window.addEventListener('keydown', (e)=>{
      if(e.key.toLowerCase()==='t' && e.shiftKey){
        adminTotal.style.display = (adminTotal.style.display==='none' || !adminTotal.style.display) ? 'block' : 'none';
      }
    });
  })();
  </script>
</body>
</html>

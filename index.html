<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>VITAMINA K ‚Äî Encuesta</title>
  <meta name="description" content="Votaci√≥n en vivo sobre intenci√≥n de voto.">
  <meta property="og:title" content="Vitamina K ‚Äî Encuesta de voto">
  <meta property="og:description" content="Participa y mira c√≥mo cambia el ranking en tiempo real.">
  <meta property="og:type" content="website">
  <style>
    *{box-sizing:border-box}
    :root{
      --bg1:#1a1f2b; --bg2:#101522; --glass:rgba(255,255,255,.10);
      --glass-2:rgba(255,255,255,.16); --stroke:rgba(255,255,255,.18);
      --fg:#fff; --muted:rgba(255,255,255,.85);
      --accent:#4ecdc4; --accent-2:#7dd3fc;
      --bar:#4ecdc4; --bar-bg:rgba(255,255,255,.15);
      --btn:#ffffff29; --btn-stroke:#ffffff44;
    }
    html,body{
      margin:0; min-height:100%;
      background:linear-gradient(135deg,var(--bg1),var(--bg2));
      color:var(--fg);
      font:16px/1.5 -apple-system,BlinkMacSystemFont,"Segoe UI",system-ui,Roboto,Inter,Arial;
    }
    .wrap{
      min-height:100vh; display:flex; align-items:center; justify-content:center; padding:24px;
    }
    .card{
      width:min(860px,96vw);
      background:var(--glass); backdrop-filter:blur(18px) saturate(1.2);
      border:1px solid var(--stroke); border-radius:20px; padding:28px;
      box-shadow:0 20px 60px rgba(0,0,0,.35);
    }
    .brand{font-weight:900; letter-spacing:.4px; text-transform:uppercase; opacity:.95; text-align:center}
    .title{font-size:clamp(22px,3.8vw,30px); text-align:center; margin:8px 0 6px}
    .sub{color:var(--muted); text-align:center; margin:0 0 20px}
    .poll{
      margin-top:6px; display:flex; flex-direction:column; gap:10px;
    }
    .row{
      display:grid; grid-template-columns: 1.1fr 3.2fr 70px; gap:12px;
      align-items:center; padding:10px 12px; border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06); cursor:pointer;
      transition:transform .08s ease, background .2s ease, border-color .2s ease;
    }
    .row:hover{ transform:translateY(-1px); background:rgba(255,255,255,.10); border-color:rgba(255,255,255,.22); }
    .row.voted{ outline:2px solid var(--accent); background:rgba(78,205,196,.12) }
    .name{ font-weight:800; letter-spacing:.2px }
    .barline{ position:relative; width:100%; height:12px; background:var(--bar-bg); border-radius:999px; overflow:hidden }
    .fill{ position:absolute; left:0; top:0; height:100%; width:0%;
           background:linear-gradient(90deg,var(--bar),var(--accent-2));
           transition: width .45s cubic-bezier(.2,.8,.2,1); }
    .pct{ text-align:right; font-variant-numeric:tabular-nums; font-weight:800 }
    .legend{ display:flex; justify-content:space-between; align-items:center; margin-top:8px; color:var(--muted); font-size:13px }
    .legend .note{ opacity:.9 }
    .legend .you{ font-weight:700; color:var(--accent) }

    /* Botones sociales + CTA */
    .actions{ margin-top:20px; display:flex; justify-content:center; gap:12px; flex-wrap:wrap }
    .btn{ padding:10px 14px; border-radius:12px; border:1px solid var(--btn-stroke);
          background:var(--btn); color:#fff; text-decoration:none; font-weight:700;
          transition:transform .12s ease, background .2s ease, border-color .2s ease; }
    .btn:hover{ transform:translateY(-2px); background:#ffffff33; border-color:#ffffff77 }
    .btn.primary{ background:var(--accent); color:#0b0f1a; border-color:transparent }
    .btn.primary:hover{ filter:brightness(.95) }

    /* Admin total oculto (toggle con Shift+C) */
    #adminTotal{ display:none; margin-top:8px; text-align:right; font-size:12px; color:#cfe9ff }
    .hint{ display: none; }
  </style>
</head>
<body>
  <div class="wrap">
    <article class="card">
      <div class="brand">VITAMINAK.OF</div>
      <h1 class="title">Encuesta r√°pida ¬∑ ¬øA qui√©n votar√≠as hoy?</h1>
      <p class="sub">Vota una sola vez. La lista se ordena sola por apoyo. Mira c√≥mo suben las barras en tiempo real.</p>

      <section class="poll" id="poll"></section>

      <div class="legend">
        <span class="note">Porcentaje sobre el total de votos de esta encuesta.</span>
        <span class="you" id="youBadge" style="display:none">Tu voto registrado ‚úì</span>
      </div>

      <div id="adminTotal">Total de votos: <span id="totalCount">0</span></div>
      <!-- Eliminado el texto de tip -->

      <div class="actions">
        <a class="btn" href="https://www.instagram.com/vitaminak.of" target="_blank" rel="noopener">üì∏ Instagram</a>
        <a class="btn" href="https://x.com/vitaminakof" target="_blank" rel="noopener">ùïè Seguir</a>
        <a class="btn primary" href="https://www.instagram.com/vitaminak.of" target="_blank" rel="noopener">üî• S√≠gueme para ver los resultados</a>
      </div>
    </article>
  </div>

  <script>
(function(){
  // =========== CONFIG ===========
  // üëá Pega aqu√≠ tu URL del Web App (la que me pasaste)
  const ENDPOINT = 'https://script.google.com/macros/s/AKfycbxfxtW-bLzKb2uPp9IImq4Ng2LhyzE8MyfQdaBSQAUr5SZmK78bf6jgD0lbwx70FKkv/exec';

  // Opciones de la encuesta (incluye nulos, abstenci√≥n y SAF)
  const OPCIONES = [
    'PSOE',
    'Sumar',
    'PP',
    'Vox',
    'Se Acab√≥ la Fiesta',
    'Abstenci√≥n',
    'Voto nulo',
    'Otros'
  ];

  // Clave local para ‚Äú1 voto por dispositivo‚Äù (puedes cambiarla para resetear)
  const LOCAL_KEY = 'vk_poll_partidos_server_v1';

  // ========= HELPERS UI =========
  const pollEl = document.getElementById('poll');
  const totalEl = document.getElementById('totalCount');
  const adminTotal = document.getElementById('adminTotal');
  const youBadge = document.getElementById('youBadge');

  // Estado local m√≠nimo: si ya vot√≥ y a qui√©n
  function getLocal(){
    try{
      return JSON.parse(localStorage.getItem(LOCAL_KEY) || '{"voted":false,"choice":""}');
    }catch(_){ return {voted:false, choice:''}; }
  }
  function setLocal(voted, choice){
    try{ localStorage.setItem(LOCAL_KEY, JSON.stringify({voted, choice})); }catch(_){}
  }

  // ========= API CALLS =========
  async function fetchResults(){
    const url = ENDPOINT + '?action=results';
    const res = await fetch(url, {method:'GET', mode:'cors', cache:'no-store'});
    if(!res.ok) throw new Error('Error de red al leer resultados');
    const data = await res.json();
    // Esperado: { ok:true, votes: { nombre:numero,... }, total:number }
    if(!data || data.ok === false) throw new Error(data?.error || 'Respuesta inv√°lida');
    // Asegura que existen todas las opciones:
    OPCIONES.forEach(n => { if(!(n in data.votes)) data.votes[n] = 0; });
    // Total consistente
    data.total = typeof data.total === 'number'
      ? data.total
      : Object.values(data.votes).reduce((a,b)=>a+(+b||0),0);
    return data;
  }

  async function sendVote(option){
    const body = new URLSearchParams({ action:'vote', option });
    const res = await fetch(ENDPOINT, {
      method:'POST',
      mode:'cors',
      headers:{ 'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8' },
      body
    });
    if(!res.ok) throw new Error('No se pudo enviar el voto');
    const data = await res.json();
    if(!data || data.ok === false) throw new Error(data?.error || 'Respuesta inv√°lida');
    return data; // mismo formato que results
  }

  // ========= RENDER =========
  function percentOf(v, t){
    if(!t) return 0;
    return Math.round((v * 10000) / t) / 100; // dos decimales
  }

  function sortedOptions(votes){
    return [...OPCIONES].sort((a,b)=>{
      const da = (votes[b]||0) - (votes[a]||0);
      if(da !== 0) return da;
      return a.localeCompare(b);
    });
  }

  function renderUI({votes, total}){
    const local = getLocal();
    pollEl.innerHTML = '';
    totalEl.textContent = total;

    const order = sortedOptions(votes);
    order.forEach(name=>{
      const row = document.createElement('div');
      row.className = 'row';
      if(local.voted && local.choice === name) row.classList.add('voted');

      const nameEl = document.createElement('div');
      nameEl.className = 'name';
      nameEl.textContent = name;

      const barline = document.createElement('div');
      barline.className = 'barline';

      const fill = document.createElement('div');
      fill.className = 'fill';

      const pct = percentOf(votes[name]||0, total);
      requestAnimationFrame(()=>{ fill.style.width = pct + '%'; });
      barline.appendChild(fill);

      const pctEl = document.createElement('div');
      pctEl.className = 'pct';
      pctEl.textContent = pct.toFixed(1) + '%';

      row.appendChild(nameEl);
      row.appendChild(barline);
      row.appendChild(pctEl);

      row.addEventListener('click', async ()=>{
        const localNow = getLocal();
        if(localNow.voted) return; // ya vot√≥ en este dispositivo
        try{
          row.style.pointerEvents = 'none';
          const data = await sendVote(name);
          setLocal(true, name);
          youBadge.style.display = 'inline';
          // re-render con resultados frescos del servidor
          renderUI(data);
        }catch(err){
          alert('No se pudo registrar tu voto. Int√©ntalo de nuevo.');
          row.style.pointerEvents = '';
        }
      }, {passive:true});

      pollEl.appendChild(row);
    });

    youBadge.style.display = getLocal().voted ? 'inline' : 'none';
  }

  // ========= INIT =========
  async function init(){
    try{
      const data = await fetchResults();
      renderUI(data);
    }catch(err){
      console.error(err);
      // Fallback m√≠nimo para que no se vea vac√≠o
      const empty = { votes:{}, total:0 };
      OPCIONES.forEach(n=>empty.votes[n]=0);
      renderUI(empty);
    }
  }

  // Toggle admin total (solo t√∫ lo ves si sabes el atajo)
  window.addEventListener('keydown', (e)=>{
    if(e.key.toLowerCase()==='t' && e.shiftKey){
      adminTotal.style.display = (adminTotal.style.display==='none' || !adminTotal.style.display) ? 'block' : 'none';
    }
  });

  init();
})();
</script>

</body>
</html>
